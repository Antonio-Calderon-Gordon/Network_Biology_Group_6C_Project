# Script:       Step1_DataExploration.R
# Description:  In this script, we will explore the differential gene 
#               expression dataset comparing breast cancer vs. healthy tissue
#               samples. The RNA-sequencing dataset was retrieved from 
#               TCGA (The Cancer Genome Atlas) and pre-processed in R. 
#               Differential gene expression analysis was performed with the 
#               DESeq2 R-package. 
# Version: 1.0
# Last updated: 2024-06-10
# Author: mkutmon

# #############################################
# R INSTRUCTIONS
# #############################################

# * Lines that start with a # are comments
# * You can run a code line by placing the cursor in the line and clicking 
#   CTRL/Command + Enter
# * In between you will see the ??? Questions which refers to a question 
#   in the question document provided on Canvas.


# #############################################
# R SETUP
# #############################################

# Here we install and load all required packages. 
if (!("BiocManager" %in% installed.packages())) { install.packages("BiocManager", update=FALSE) }
if (!("rstudioapi" %in% installed.packages())) { BiocManager::install("rstudioapi", update=FALSE) }
if (!("org.Hs.eg.db" %in% installed.packages())) { BiocManager::install("org.Hs.eg.db", update=FALSE) }
if (!("dplyr" %in% installed.packages())) { BiocManager::install("dplyr", update=FALSE) }
if (!("EnhancedVolcano" %in% installed.packages())) { BiocManager::install("EnhancedVolcano", update=FALSE) }
if (!("readxl" %in% installed.packages())) { BiocManager::install("readxl", update=FALSE) }
if (!("clusterProfiler" %in% installed.packages())) { BiocManager::install("clusterProfiler", update=FALSE) }
if (!("enrichplot" %in% installed.packages())) { BiocManager::install("enrichplot", update=FALSE) }
if (!("Rgraphviz" %in% installed.packages())) { BiocManager::install("Rgraphviz", update=FALSE) }
if (!("RCy3" %in% installed.packages())) { BiocManager::install("RCy3", update=FALSE) }
if (!("msigdbr" %in% installed.packages())) { BiocManager::install("msigdbr",update=FALSE) }
if (!("RColorBrewer" %in% installed.packages())) { BiocManager::install("RColorBrewer",update=FALSE) }
if (!("readr" %in% installed.packages())) { BiocManager::install("readr",update=FALSE) }
if (!("rWikiPathways" %in% installed.packages())) { BiocManager::install("rWikiPathways",update=FALSE) }

library(rstudioapi)
library(org.Hs.eg.db)
library(dplyr)
library(EnhancedVolcano)
library(readxl)
library(clusterProfiler)
library(enrichplot)
library(Rgraphviz)
library(RCy3)
library(msigdbr)
library(RColorBrewer)
library(readr)
library(rWikiPathways)

# We will set the working directory to the location where the current 
# script is located. This way, we can use relative file path locations. 
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# We will create an output folder where all figures and files will be stored
out.folder <- "output/"
dir.create(out.folder)


# #############################################
# IMPORT DATA
# #############################################

# Next we will import the dataset
data <- read_excel("data/data-breast-cancer.xlsx")


# #############################################
# DIFFERENTIALLY EXPRESSED GENES
# #############################################

# Let's see how many genes are differentially expressed in our dataset

log2fc.cutoff <- 1
pvalue.cutoff <- 0.05
degs <- data[abs(data$log2FC) > log2fc.cutoff & data$PValue < pvalue.cutoff,]

# let's write out the table with all differentially expressed genes
write.table(degs, file=paste0(out.folder,"degs.tsv"), row.names = FALSE, sep="\t", quote = FALSE)


# Based on the code in line 68, can you adapt the code to select only up- or
# down-regulated genes? 

genes.up <- 1
genes.down <- -1
genes.up <- data[data$log2FC > log2fc.cutoff & data$PValue < pvalue.cutoff,]
genes.down <- data[data$log2FC < -log2fc.cutoff & data$PValue < pvalue.cutoff,]



# Add a label column to highlight the three specific genes of interest
genes_of_interest <- c("PIK3CA", "EGFR", "PIK3R2")  # replace with your gene IDs
data$label <- ifelse(data$GeneName %in% genes_of_interest, data$GeneName, NA)

print(data[data$GeneName %in% genes_of_interest, c("GeneName", "label")])


# #############################################
# VOLCANO PLOT
# #############################################

# Let's create a Volcano plot to get a better understand of the intensity and
# direction of the changed genes
# Let's highlight the genes of interest and point them out in yellow

EnhancedVolcano(data, title = paste0("Breast Cancer vs. Healthy (",nrow(degs), " DEGs)"), lab = data$label, x = "log2FC", y = "PValue", pCutoff = pvalue.cutoff, FCcutoff = log2fc.cutoff, labSize = 8, selectLab = genes_of_interest, drawConnectors = TRUE, widthConnectors = 4, colConnectors = "yellow", xlim = c(-15,15), ylim=c(0,8))

# the code below saves the figure in a file in our output folder
filename <- paste0(out.folder,"volcano-plot-new.png")
png(filename , width = 4000, height = 2500, res = 300)
EnhancedVolcano(data, title = paste0("Breast Cancer vs. Healthy (",nrow(degs), " DEGs)"), lab = data$label, x = "log2FC", y = "PValue", pCutoff = pvalue.cutoff, FCcutoff = log2fc.cutoff, labSize = 8, selectLab = genes_of_interest, drawConnectors = TRUE, widthConnectors = 4, colConnectors = "yellow", xlim = c(-15,15), ylim=c(0,8))
dev.off()
